stages:
  - build
  - deploy
  - load-test

variables:
  SSH_KEY: "/home/devops/.ssh/id_rsa"
  APP_SERVER: "10.0.0.7"
  WEB_SERVERS: "10.0.0.8 10.0.0.9"
  DOCKER_IMAGE_BACKEND: "metrics-backend"
before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - ssh-add /home/gitlab-runner/.ssh/id_rsa
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan -H 10.0.0.7 >> ~/.ssh/known_hosts
  - ssh-keyscan -H 10.0.0.8 >> ~/.ssh/known_hosts
  - ssh-keyscan -H 10.0.0.9 >> ~/.ssh/known_hosts

# For backend
build-backend:
  stage: build
  tags:
    - shell
  script:
    - echo "Building backend Docker image on app-server..."
    - ssh devops@$APP_SERVER "
        if [ ! -d ~/metrics-backend ]; then
          git clone https://github.com/Pippah1/metrics-build.git ~/metrics-backend;
        else
          cd ~/metrics-backend && git pull;
        fi &&
        cd ~/metrics-backend/server &&
        docker build -t $DOCKER_IMAGE_BACKEND .
      "

deploy-backend:
  stage: deploy
  tags:
    - shell
  script:
    - echo "Deploying backend container on app-server..."
    - ssh devops@$APP_SERVER "docker stop metrics-backend || true && docker rm metrics-backend || true"
    - ssh devops@$APP_SERVER "docker run -d --name metrics-backend -p 3000:3000 $DOCKER_IMAGE_BACKEND"

# For frontend
build-frontend:
  stage: build
  tags:
    - shell
  script:
    - |
      for server in $WEB_SERVERS; do
        echo "Building frontend Docker image on $server..."
        ssh devops@$server '
          NAME=$(hostname)

          if [ ! -d ~/metrics-frontend ]; then
            git clone https://github.com/Pippah1/metrics-build.git ~/metrics-frontend
          else
            cd ~/metrics-frontend && git pull
          fi

          cd ~/metrics-frontend/client
          docker build \
            --build-arg VITE_WEB_SERVER_NAME="$NAME" \
            -t "$NAME" .
        '
      done

deploy-frontend:
  stage: deploy
  tags:
    - shell
  script:
    - |
      for server in $WEB_SERVERS; do
        echo "Deploying frontend container on $server..."
        ssh devops@$server '
          NAME=$(hostname)

          docker stop "$NAME" || true
          docker rm "$NAME" || true

          docker run -d \
            --name "$NAME" \
            -p 5173:5173 \
            "$NAME"
        '
      done

k6-load-test:
  stage: load-test
  image: grafana/k6:latest
  tags:
    - shell
  before_script: []
  script:
    - echo "Running k6 load test against load balancer..."
    - k6 run k6/loadtest.js
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
